<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Non-parametric Bootstrapping • MDChelp</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Non-parametric Bootstrapping">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MDChelp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.01</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Bootstrapping.html">Non-parametric Bootstrapping</a></li>
    <li><a class="dropdown-item" href="../articles/CCAMarked.html">Capture-Recapture: Closed Capture Abundance - Marked Individuals</a></li>
    <li><a class="dropdown-item" href="../articles/CROverview.html">Capture-Recapture: Overview</a></li>
    <li><a class="dropdown-item" href="../articles/Quick-Nimble-Demo.html">Quick Nimble Demo</a></li>
    <li><a class="dropdown-item" href="../articles/TTE-Advanced.html">Time To Event and Known-fate (Survival) Analyses</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tlyons253/MDChelp/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Non-parametric Bootstrapping</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tlyons253/MDChelp/blob/master/vignettes/articles/Bootstrapping.Rmd" class="external-link"><code>vignettes/articles/Bootstrapping.Rmd</code></a></small>
      <div class="d-none name"><code>Bootstrapping.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="linear-model-basics">Linear Model Basics<a class="anchor" aria-label="anchor" href="#linear-model-basics"></a>
</h2>
<p>When you fit a model to data, you are making assumptions about those
data, typically (but not limited to) something about how those data are
distributed or how the terms of the model are related to the response
(e.g., linear). There can be some other assumptions some examples
are:</p>
<ul>
<li>Simple linear model/regression (LM)
<ul>
<li>Typically used for continuous variables</li>
<li>Model terms and response are linearly related</li>
<li>The <em>residuals</em> are normally distributed with homogeneous
variance.</li>
</ul>
</li>
<li>Log-linear (Poisson) model/regression
<ul>
<li>Typically used to model count data</li>
<li>Model terms and the <strong>log</strong> response are linear
related</li>
<li>The mean of the response is equal to the variance (Poisson)</li>
</ul>
</li>
</ul>
<p>Those assumptions are sometimes not met which has important negative
consequences for your results. John Fieberg’s book <a href="https://statistics4ecologists-v3.netlify.app/" class="external-link"><em>Statistics for
Ecologists</em></a> goes into more details, but it’s bad. The long and
short of it is:</p>
<ul>
<li>If you violate the linearity assumption, your regression
coefficients are biased. Think about if you left out a quadratic term of
a linear model e.g.</li>
</ul>
<p><span class="math display">\[Y=\beta_0+\beta_1\cdot x_1\\
\\
vs\\
\\
Y=\beta_0+\beta_1\cdot x_1 + \beta_2\cdot (x_1)^2\]</span></p>
<p>Using just the linear term <span class="math inline">\((\beta_1)\)</span> would not accurately describe
the relationship between <span class="math inline">\(Y\)</span> and
<span class="math inline">\(x_1\)</span> so <span class="math inline">\(\beta_1\)</span> would be biased.</p>
<ul>
<li><p>Another common area where this can be an issue is if you use a
covariate that is an areal measurement or a count of something else that
has a verrrry broad scale (values from 10’s to 1,000’s or more). The
issue isn’t the nature of the variable per se, but the fact the scale is
very, very broad. This also leads to the response and covariates not
being linearly related.</p></li>
<li><p>When other assumptions about the model/data aren’t met, such as
the normal residuals in a LM or mean-equal-to-variance in a Poisson, the
sampling distribution of <span class="math inline">\(\beta\)</span> is
underestimated. This means the reported SE for any particular <span class="math inline">\(\beta\)</span> is too small and any resulting
confidence interval or p-value will be incorrect.</p></li>
</ul>
<p>What to do when you violate these assumptions?</p>
<p>If the linearity assumption is not supported, you change the type of
model (or the assumed underlying distribution) or perform some kind of
transformation and this ensures the linear relationship is met. In the
case of covariates that have very broad ranges, you may log transform
the covariate. Often this will clear up most issues, but other
assumptions about variances or residuals may not be met.</p>
<p>For example, in Poisson regression, the most common type of violation
is <strong><em>greater</em></strong> variance than expected, or data
being overdispersed. In practice, overdispersion can arise because you
omit some kind of grouping variable (e.g. ignoring the potential for
correlated survival probability of gamebird chicks in the same brood),
or because there are more 0’s than expected. If you were to fit a model
that ignored these factors, you can no longer trust the SE’s , CI’s, or
p-values of your <span class="math inline">\(\beta's\)</span> output
by typical routines (e.g. glm in R; <a href="https://statistics4ecologists-v3.netlify.app/10-maximumlikelihood#sec-profile" class="external-link">See
this section</a> of Dr. Fieberg’s book for a more in-depth discussion of
issues with the CI’s and p-values reported in in common software
functions) and you might find that a goodness-of-fit (GOF) test would
indicate the model is a poor fit. In a simple LM, you may find that no
matter the transformation you use, or what other terms you add, you
still don’t have normal residuals.</p>
<p>To fix that problem you could include a random effect of some
grouping variable (brood in the first case), or change the distribution,
like switching to a negative binomial distribution in the second case.
But even if you specify the model correctly, and try out different
distributions, you may find that your model does not pass a GOF test.
What do do? Bootstrap your data.</p>
</div>
<div class="section level2">
<h2 id="how-to-bootstrap">How to bootstrap<a class="anchor" aria-label="anchor" href="#how-to-bootstrap"></a>
</h2>
<p>Bootstrapping comes in 3 flavors (parametric, semi-parametric,
non-parametric) but only non-parametric bootstrapping is discussed here
and consequently everything described here may not hold under other
bootstrap alternatives. In the case of the non-parametric bootstrap, you
relax the distributional assumptions of your model (mean/ variance
relationship, residuals) and instead make different assumptions, namely
that your resampling scheme matches the original sampling scheme. You
still have to have deal with issues like linearity, independence, etc.
either through the model itself and/or via the resampling method. If
those assumptions can still be met, then the bootstrap allows you to
estimate the <em>distribution</em> of parameters, be they the regression
coefficients (<span class="math inline">\(\beta's\)</span>) or other
model-based estimates or predictions.</p>
<p>The short version is, you can use the bootstrap to estimate the SE of
a parameter. How does this work? The brief version is:</p>
<ol style="list-style-type: decimal">
<li>Resample your data <em>WITH</em> replacement</li>
<li>Estimate model parameters, save those parameters</li>
<li>Repeat a few thousand times</li>
</ol>
<p>You should then have N estimates of each parameter. These N estimates
comprise an approximation of the <em>distribution</em> of the parameter.
You don’t use it to estimate a parameter, but the SE/ CI of that
parameter instead. DO NOT USE THE DISTRIBUTION TO ESTIMATE THE PARAMETER
ITSELF, ONLY THE SE/CI. The best estimate of the parameter mean comes
from the model using the original data.</p>
<div class="section level3">
<h3 id="determining-the-resampling-scheme">Determining the resampling scheme<a class="anchor" aria-label="anchor" href="#determining-the-resampling-scheme"></a>
</h3>
<p>The validity of the bootstrap is dependent on the resampling scheme
matching the manner in which data were collected, preserving the random
structures in the sampling process. This is easy if all the observations
were randomly sampled. You can then just resample the data, as is, at
random. Like this code below that creates 10 bootstrap data sets from
the original data,<code>tmp</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>           X2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Y<span class="op">=</span><span class="fl">0.2</span><span class="op">*</span><span class="va">X1</span><span class="op">+</span><span class="va">X2</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">X2</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">tmp</span></span>
<span></span>
<span><span class="co">#Create 10 bootstrapped data sets</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>,size<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>              <span class="va">tmp</span><span class="op">[</span><span class="va">.</span>,<span class="op">]</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">boot.dat</span></span>
<span></span>
<span><span class="va">boot.dat</span></span></code></pre></div>
<p>if you print <code>boot.dat</code>, you should see 10 different data
frames. You can see the row labels that identify which observations
comprise the new data. If an observation in the original data was
sampled more than once, it gets a decimal value. For example, a row
labeled 5.3 would be the 3rd appearance in the bootstrapped data of an
observation that was the 5th row in the original data. In this example,
you only have 10 bootstrapped data sets, but in reality, you probably
want a minimum of 2,000. In fact, if your resampling scheme is more
complex, you will likely need more than 2,000; possibly as many as
10,000.</p>
<p>The resampling gets more complicated when you start having data that
naturally falls in clusters. This could be something you account for in
the model, as a fixed or random effect. The important part is, it’s not
something that arises randomly in the observation (i.e. randomly
sampling people and observing eye color), It’s a part of the study
design (randomly sampling 5 people with blue eyes, 5 with brown, etc.)
When a cluster/variable is a fixed effect and is part of the study
design, you do not resample at the level of a fixed effect, but it does
need to be accounted for in the resampling scheme. If that same variable
is treated as a random effect, it does get resampled.</p>
<p>For example, think of a study where test scores are collected from
students, in 5 classrooms per school, in 4 schools:</p>
<ol style="list-style-type: decimal">
<li>Schools aren’t randomly selected, classrooms within a school are
randomly selected, but all 20 students within a classroom are
measured,</li>
</ol>
<ul>
<li>Original data consists of 400 rows, with 25 levels of classrooms and
5 levels of school.
<ul>
<li>Resample 5 classrooms within each school, with replacement</li>
<li>Do not resample students within classrooms.</li>
<li>Do not resample schools.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">demo.dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>school<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Hogwarts"</span>,</span>
<span>                               <span class="st">"Tattoine P.S. 1"</span>,</span>
<span>                               <span class="st">"Hobbition Elementary"</span>, </span>
<span>                               <span class="st">"Mordor Primary"</span><span class="op">)</span>,</span>
<span>                      room<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>                      student<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span></span>
<span>                      <span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>score<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">50</span><span class="op">:</span><span class="fl">100</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         room<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">school</span>,<span class="st">'_'</span>,<span class="va">room</span><span class="op">)</span>,</span>
<span>         student_id<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create 1 bootstrap data sets by creating indices of the data selected. Run the code block, line by line (cumulatively), to see what is being done at each step.</span></span>
<span><span class="va">demo.dat</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">school</span>, <span class="va">room</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">school</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">.x</span>,n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span><span class="va">.</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">demo.dat</span>,</span>
<span>                       <span class="va">school</span><span class="op">==</span><span class="op">{</span><span class="va">..1</span><span class="op">}</span>,</span>
<span>                       <span class="va">room</span><span class="op">==</span><span class="op">{</span><span class="va">..2</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#create 10 data sets</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,<span class="op">~</span><span class="va">demo.dat</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">school</span>, <span class="va">room</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">school</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">.x</span>,n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span><span class="va">.</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">demo.dat</span>,</span>
<span>                       <span class="va">school</span><span class="op">==</span><span class="op">{</span><span class="va">..1</span><span class="op">}</span>,</span>
<span>                       <span class="va">room</span><span class="op">==</span><span class="op">{</span><span class="va">..2</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">boot.10</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">boot.10</span>,<span class="op">~</span><span class="va">.x</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">school</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># number of students from each school</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">boot.10</span>,<span class="op">~</span><span class="va">.x</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">school</span>,<span class="va">room</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># number of students from each school</span></span></code></pre></div>
<p>In this scenario, only the classrooms were randomly selected so that
is all that was randomly sampled. Every school is still represented with
100 students from each school, but the number of different classrooms
differs, leading to some classrooms accounting for more than 20
students.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gdata</span><span class="fu">::</span><span class="fu">keep</span><span class="op">(</span><span class="va">demo.dat</span>,sure<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>What if 10 students were randomly sampled in each classroom instead
of all 20? Now you just make sure that those students are also resampled
within each classroom.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make an "original" data set of 10 students from each classroom. We are pretending the other 10 students were never measured. You won't do this step ever with your data</span></span>
<span><span class="va">demo.dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>school<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Hogwarts"</span>,</span>
<span>                               <span class="st">"Tattoine P.S. 1"</span>,</span>
<span>                               <span class="st">"Hobbition Elementary"</span>, </span>
<span>                               <span class="st">"Mordor Primary"</span><span class="op">)</span>,</span>
<span>                      room<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>                      student<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="co">#This is now 10 students</span></span>
<span>                      <span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>score<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">50</span><span class="op">:</span><span class="fl">100</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         room<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">school</span>,<span class="st">'_'</span>,<span class="va">room</span><span class="op">)</span>,</span>
<span>         student_id<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># create one bootstrap data set ---------------------------------------------</span></span>
<span></span>
<span></span>
<span><span class="co"># create indexes of randomly sampled classrooms (within schools) and students</span></span>
<span>  <span class="va">demo.dat</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">school</span>, <span class="va">room</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">school</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">.x</span>,n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">school.room.idx</span> <span class="co"># list of resampled classrooms</span></span>
<span></span>
<span>  <span class="co">#use the list of resampled classrooms to resample students within</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span><span class="va">school.room.idx</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">demo.dat</span>,</span>
<span>                               <span class="va">school</span><span class="op">==</span><span class="op">{</span><span class="va">..1</span><span class="op">}</span>,</span>
<span>                               <span class="va">room</span><span class="op">==</span><span class="op">{</span><span class="va">..2</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">.x</span>,n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>         </span>
<span><span class="co"># List is 20 elements long, with 5 elements per school. Room ID's may be</span></span>
<span><span class="co"># repeated within a school and student_id can be repeated within a room. </span></span>
<span>  </span>
<span><span class="co"># make 10 data sets where classrooms in schools and students in classrooms are randomly resampled  </span></span>
<span>  </span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,<span class="op">~</span> <span class="va">demo.dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">school</span>, <span class="va">room</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">school</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>,  <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">.x</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span><span class="va">.</span>,  <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">demo.dat</span>,</span>
<span>                      <span class="va">school</span> <span class="op">==</span> <span class="op">{</span><span class="va">..1</span><span class="op">}</span>,</span>
<span>                      <span class="va">room</span> <span class="op">==</span> <span class="op">{</span><span class="va">..2</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>,  <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">.x</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">boot.10</span></span></code></pre></div>
<p>Go and inspect boot.10 again. Now, rather than each student appearing
once each time the classroom appears in bootstrap, each student may
appear &gt;1 time each time their classroom is selected. There are still
5 classrooms per school and 10 observations per school/classroom, it’s
just now some appear more than once. So previously, the MOST a student
could appear in a bootstrapped data set was 5 times (assuming their
classroom was randomly selected 5x). Now, in theory, that student could
appear as many as 50 times (their classroom was selected all 5 times,
and they were selected all 10 times, each of those 5x).</p>
<p>You can adjust the sampling scheme by allowing for random sampling at
different levels, or combining variables to construct the appropriate
“cluster” to perform resampling on. Just remember, if it was randomly
selected in study design, it needs to be randomly sampled in the
bootstrap.</p>
</div>
<div class="section level3">
<h3 id="deriving-se-and-cis">Deriving SE and CI’s<a class="anchor" aria-label="anchor" href="#deriving-se-and-cis"></a>
</h3>
<p>Once you have your bootstrap estimates, make a density plot or a
histogram and determine if the distribution for each parameter is normal
or close enough. Close enough counts here because you should have
thousands of estimates.</p>
<ul>
<li><p>If it looks normal, you can compute the SE of those bootstrap
estimates (e.g. <code>sd(boostrap_estimates$Var1-&gt;SE</code>) and then
compute the 95% (or some other %) confidence interval as <span class="math inline">\(\mu\ \pm\ 1.96\times\ SE\)</span> where <span class="math inline">\(\mu\)</span> again is the estimate from the model
using the original data.</p></li>
<li>
<p>If it shows skew (which it likely will, even if it’s just fat
tails), you need to use some form of a quantile
(e.g.<code>quantile(SE,c(0.025,0.975)</code>). You cannot, however,
derive the CI from a simple call to <code>quantile</code>. The interval
you get might not include the mean you obtained using the original
data.</p>
<ul>
<li>If you need to use quantile intervals, you need to use a
bias-corrected (and/or accelerated, BCa) confidence interval.
<ul>
<li>The <code>bcaboot</code> package will perform it for you, but it
handles all steps of the bootstrap process from resampling data to
computing statistics. So unless the statistics you’re after are
straightforward (or your resampling scheme is simple) you may not be
able to utilize it.</li>
<li>Another version exists in the<code>coxed</code> package via
<code>coxed::bca()</code>. Do not use this. It is not appropriate for a
non-parametric bootstrap.</li>
<li>The <code>MDChelp</code> package has functions that will compute the
BCa interval given a table of bootstrapped estimates and the original
data (<code>MDChelp::bca_jacknife</code>). Right now, it’s only been
tested for creating a table of regression parameter estimates and the
CI’s <span class="math inline">\((\beta's)\)</span> but you might be
able to get it to do the same for model-based estimates (e.g. marginal
means, contrasts, etc.) depending on how you identify a parameter of
interest in the table and the function you provide.</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="deriving-p-values">Deriving P-values<a class="anchor" aria-label="anchor" href="#deriving-p-values"></a>
</h3>
<p>You typically don’t estimate a p-value from the bootstrap. To do
that, you would need a permutation test. If your inference relies on
reporting or interpreting p-values:</p>
<ol style="list-style-type: decimal">
<li>Don’t.</li>
<li>Use a permuation test instead. There are “approximations” you can
use by calculating T (or presumably F) statistics, but again, this seems
at odds with the whole purpose of using a non-parametric bootstrap.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="example-workflow">Example Workflow<a class="anchor" aria-label="anchor" href="#example-workflow"></a>
</h2>
<p>Here is a real worked example that includes tips to save on
computational speed/ memory.</p>
<div class="section level4">
<h4 id="computational-tips">Computational tips<a class="anchor" aria-label="anchor" href="#computational-tips"></a>
</h4>
<p>When you do a real bootstrap, you can take advantage of parallel
processing and avoid running into memory limits by writing the
bootstrapped data to a file on your hard drive. This makes it very easy
to use <code>furrr</code> and <code>purrr</code> to execute your
analysis and organize your results.</p>
</div>
<div class="section level3">
<h3 id="create-bootstrapped-data">Create bootstrapped data<a class="anchor" aria-label="anchor" href="#create-bootstrapped-data"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#create a set of dummy data</span></span>
<span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>,</span>
<span>            G<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>,each<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>            noise<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>           <span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Y<span class="op">=</span><span class="fl">1</span><span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="va">G</span><span class="op">+</span><span class="fl">0.2</span><span class="op">*</span><span class="va">X</span><span class="op">+</span><span class="va">noise</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">noise</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">tmp</span></span>
<span></span>
<span><span class="va">folder.name</span><span class="op">&lt;-</span><span class="st">"Yourpath/boot_data/"</span></span>
<span><span class="co">#complete path to a folder to hold bootstrapped data. Create this folder ahead of time</span></span>
<span></span>
<span><span class="co">#assume G is part of the sampling design, but is not random so observations must be randomly sampled within each level of G</span></span>
<span></span>
<span><span class="co"># write the function to do the bootstrapping and write to file, given just the original data and a counter, i. Essentially write a function that resamples the data appropriately, once.</span></span>
<span></span>
<span></span>
<span><span class="va">make.bootdat</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">X</span>,<span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">X</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">G</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>,<span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">.x</span>,n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">out</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">out</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">folder.name</span>,<span class="st">'bootdat_'</span>,<span class="va">i</span>,<span class="st">'.rds'</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="co">#always save RDS, use the counter i to name each replicate data set   </span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># now use purrr:: walk to execute the above function multiple times</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>,<span class="op">~</span><span class="fu">make.bootdat</span><span class="op">(</span><span class="va">tmp</span>,<span class="va">.x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now the data is written to a folder specified in folder path.</p>
<p>There may or may not be any memory savings when generating data by
executing in parallel, but there almost certainly will be when running
your analysis. Parallel processing is easy in the <code>furrr</code>
package because in our case, it will split the data objects just created
among however many cores/workers we specify. This means it might be
helpful to do some math ahead of time and figure out how many cores you
want to assign. Most mid-range computers now will have up to 8 ‘logical’
cores (4 physical) than can be use (assuming a Windows OS). You need to
reserve at least 1 to handle other processes. Beyond that it’s up to
you. I generally try to use the number of cores that results in the same
number of data objects being assigned to each core. No clue if this
actually helps or hurts, but it’s what I do…</p>
</div>
<div class="section level3">
<h3 id="create-model-objects">Create model objects<a class="anchor" aria-label="anchor" href="#create-model-objects"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#create a list of file paths for all the bootstrapped data</span></span>
<span></span>
<span><span class="va">bootdat.list</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="st">'your path/boot_data/'</span>,</span>
<span>                         full.names<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                         pattern<span class="op">=</span><span class="st">'.rds'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#write a function that will take the file path, read in that data object, do the desired analysis. you can make it write to memory/ workspace, or to a folder again. I like to write the model object (if using a model) at this stage because then you have more flexibility later on to get regression coefficents or compute contrasts/ marginal means without needing to re-run the model</span></span>
<span></span>
<span></span>
<span><span class="va">reg.fxn.1</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">boot.dat</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">+</span><span class="va">G</span>,data<span class="op">=</span><span class="va">boot.dat</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">out</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#same as above, but writes to file. Needs a counter, i</span></span>
<span></span>
<span><span class="va">reg.fxn.2</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">X</span>,<span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">boot.dat</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">+</span><span class="va">G</span>,data<span class="op">=</span><span class="va">boot.dat</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">out</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">out</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Yourpath/boot_mods/model_'</span>,<span class="va">i</span>,<span class="st">'.rds'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co">#non-parallel, write results to memory/workspace</span></span>
<span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">bootdat.list</span>,<span class="op">~</span><span class="fu">reg.fxn.1</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">coef.tab.list</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># set up the parallel processing structure only use if you write the objects to a file, not to memory.</span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu">plan</span><span class="op">(</span>strategy<span class="op">=</span><span class="st">'multisession'</span>,</span>
<span>             workers<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co"># use walk2 because we are writing to a file, and create the counter vector as a second argument for walk2 </span></span>
<span><span class="fu">furrr</span><span class="fu">::</span><span class="fu">future_walk2</span><span class="op">(</span><span class="va">bootdat.list</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bootdat.list</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="op">~</span><span class="fu">reg.fxn.2</span><span class="op">(</span><span class="va">.x</span>,<span class="va">.y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu">plan</span><span class="op">(</span>strategy<span class="op">=</span><span class="st">'sequential'</span><span class="op">)</span> <span class="co">#turn off parallel processing</span></span></code></pre></div>
<p>From here you can use <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map</a></code> to process the model
object further, depending on what you want to do. Just remember, if you
want to do it in parallel,you need to be reading/writing from file, not
from memory. But once you have your desired result (maybe just the model
object), you can store it in memory. For simplicity here, we will just
assume we want to just get a table of regression coefficients and the
BCa intervals. I’ll use the model objects stored in the workspace, but
the only tweak needed to be made to the function is to have it read in
the data first, like we did in <code>reg.fxn.2()</code>.</p>
</div>
<div class="section level3">
<h3 id="summarize-estimates-and-compute-bca-intervals">Summarize estimates and compute BCa intervals<a class="anchor" aria-label="anchor" href="#summarize-estimates-and-compute-bca-intervals"></a>
</h3>
<p>The <code>MDChelp::bca_jacknife()</code> function needs a table of
named parameters and the bootstrapped estimates. This is easy to obtain
using <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">broom::tidy()</a></code>. It wants the column that represents
the parameter value to be called “theta.boot”. You also need to pass a
function that replicates the analysis step previously-whatever you
wanted to do to the original data to make it match the format of the
bootstrapped estimates (e.g. the reg.fxn above). It may need some slight
tweaks so that it doesn’t write to a folder.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">coef.tab.list</span>,<span class="op">~</span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">term</span>,</span>
<span>             theta.boot<span class="op">=</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co">#rename the value to theta.boot</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">boot.param.tab</span> <span class="co"># bind rows to make it all one data frame</span></span>
<span></span>
<span><span class="co">#function to analyze the original data, similar to reg.fxn above.</span></span>
<span><span class="va">bca.fxn</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">G</span><span class="op">+</span><span class="va">X</span>,data<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span><span class="op">-&gt;</span><span class="va">out</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="fu">MDChelp</span><span class="fu">::</span><span class="fu">bca_jacknife</span><span class="op">(</span><span class="va">boot.param.tab</span>,<span class="va">tmp</span>,<span class="va">bca.fxn</span>,alpha<span class="op">=</span><span class="fl">0.05</span>,multcomp<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Alpha sets the error rate and multcomp determines whether that is the
family-wide error rate (testing whether all parameters are = 0) or on a
per-variable basis. This uses the Sidak method of correction. This is
only intended to be used when returning a table of regression
coefficients. If you are doing something other than returning a table of
regression coefficients (e.g. using emmeans, ggeffects), you should set
<code>multcomp=FALSE</code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tim Lyons.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
